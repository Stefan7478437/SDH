<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDH</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233B82F6'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        /* Custom styles for the Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .modal-overlay.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Custom Alert Modal Styles */
        #custom-alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than other modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #custom-alert-modal.open {
            opacity: 1;
            visibility: visible;
        }

        #custom-alert-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        #custom-alert-modal.open #custom-alert-content {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="app-root" class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-200 font-inter text-gray-800 antialiased">
    <header class="bg-white shadow-xl py-6 px-4 sm:px-6 lg:px-8 rounded-b-3xl">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-4 sm:mb-0">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-800 drop-shadow-md">
                    SDH
                </span>
                <span id="website-version" class="ml-4 text-xl font-semibold text-gray-600"></span>
            </h1>
            <div class="flex flex-col sm:flex-row items-center gap-4 mt-4 sm:mt-0" id="header-buttons-container">
                </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8" id="main-content-area">
        </main>

    <section class="bg-blue-600 text-white rounded-xl p-8 text-center shadow-lg mt-12">
        <h2 class="text-3xl font-bold mb-4">Can't find what you're looking for?</h2>
        <button id="request-file-button" class="inline-flex items-center justify-center px-8 py-4 border border-white text-base font-medium rounded-xl shadow-sm text-blue-600 bg-white hover:bg-blue-50 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white transition-all duration-300 transform hover:scale-105">
            Request File
        </button>
    </section>

    <footer>
        <div class="max-w-7xl mx-auto text-center text-sm">
            <p>&copy; <span id="current-year"></span> SDH. All rights reserved.</p>
            <p class="mt-2">
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-200 mx-2">Privacy Policy</a> |
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-200 mx-2">Terms of Service</a>
            </p>
        </div>
    </footer>

    <div class="fixed bottom-4 right-4 bg-gray-800 text-white text-xs px-2 py-1 rounded-full z-50">
        <span class="block sm:hidden">XS</span>
        <span class="hidden sm:block md:hidden">SM</span>
        <span class="hidden md:block lg:hidden">LG</span>
        <span class="hidden lg:block xl:hidden">XL</span>
        <span class="hidden xl:block 2xl:hidden">2XL</span>
    </div>
</div>

<div id="manage-users-modal" class="modal-overlay">
    <div class="modal-content">
        <button id="close-manage-users-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">
            &times;
        </button>
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Manage Users</h2>

        <div class="mb-6 border-b pb-4">
            <h3 class="text-xl font-semibold mb-3">Add New User</h3>
            <input type="email" id="new-user-email" placeholder="New user email" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2" />
            <div class="flex items-center mb-3">
                <input type="checkbox" id="new-user-is-admin" class="mr-2 h-5 w-5 text-blue-600 rounded" />
                <label for="new-user-is-admin" class="text-gray-700">Grant Admin Access</label>
            </div>
            <p id="add-user-message" class="text-sm mt-1 mb-2"></p>
            <button id="add-user-button" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Add User</button>
        </div>

        <div>
            <h3 class="text-xl font-semibold mb-3">Current Users</h3>
            <ul id="user-list" class="space-y-3">
                </ul>
        </div>
    </div>
</div>

<div id="custom-alert-modal" class="modal-overlay">
    <div id="custom-alert-content" class="modal-content">
        <p id="custom-alert-message" class="text-lg text-gray-800 mb-6"></p>
        <button id="custom-alert-ok-button" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">OK</button>
    </div>
</div>

<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";


    // --- IMPORTANT: YOUR FIREBASE CONFIGURATION GOES HERE ---
    // Replace the placeholder values below with your actual config from Firebase Console:
    // Go to Firebase Console -> Project settings (gear icon) -> General -> Your apps -> Web app -> Firebase SDK snippet -> Config
    const firebaseConfig = {
    apiKey: "AIzaSyAnWJNS-YQ5I76tXLGus8GDf22JtabXkmU",
    authDomain: "sdh-e70c0.firebaseapp.com",
    projectId: "sdh-e70c0", // <--- THIS MUST BE 'sdh-e70c0'
    storageBucket: "sdh-e70c0.firebasestorage.app",
    messagingSenderId: "579727761679",
    appId: "1:579727761679:web:6d14d658a03ae564b61e7a",
    measurementId: "G-ZTXL9QFXVM"
    };

    // Initialize Firebase
    let app, db, auth, analytics;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        analytics = getAnalytics(app); // Initialize analytics here
    } catch (e) {
        console.error("Firebase initialization failed:", e);
        // Using customAlert instead of window.alert
        customAlert("Failed to initialize Firebase. Please check your console for errors and ensure your firebaseConfig is correct.");
    }

    // Define the email address where access requests will be sent
    const REQUEST_RECIPIENT_EMAIL = 'stefan.mitarca@gmail.com';
    // Define the email address for file requests
    const REQUEST_FILE_EMAIL = 'SDH_SUP@mail.com';
    // Define the website version
    const WEBSITE_VERSION = 'v1.0.8';

    // Local authentication state
    let isAuthenticated = false;
    let isAdminUser = false;
    let userEmail = null;
    let currentUserId = null; // Store Firebase User ID
    let currentView = 'downloads'; // 'downloads' or 'tutorials' or 'admin'

    // Allowed users from Firestore (this will be populated by the onSnapshot listener)
    let ALLOWED_USERS = [];

    // Firestore Collection Reference
    let usersCollectionRef;
    // Check if db and firebaseConfig.projectId are valid before initializing usersCollectionRef
    if (db && firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
        // Construct the collection path using the actual projectId from your config
        usersCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/public/data/allowedUsers`);
    } else {
        console.warn("Firebase projectId is not set or is still a placeholder. Firestore collection reference not fully initialized.");
    }

    /**
     * Custom alert function to replace window.alert
     * @param {string} message - The message to display in the alert.
     */
    function customAlert(message) {
        const alertModal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('custom-alert-message');
        const alertOkButton = document.getElementById('custom-alert-ok-button');

        alertMessage.textContent = message;
        alertModal.classList.add('open');

        // Close when OK is clicked or outside is clicked
        const closeAlert = () => {
            alertModal.classList.remove('open');
            alertOkButton.removeEventListener('click', closeAlert);
            alertModal.removeEventListener('click', handleOutsideClick);
        };

        const handleOutsideClick = (e) => {
            if (e.target === alertModal) {
                closeAlert();
            }
        };

        alertOkButton.addEventListener('click', closeAlert);
        alertModal.addEventListener('click', handleOutsideClick);
    }

    // Replace default alert with customAlert
    window.alert = customAlert;

    /**
     * Sets up a real-time listener for the allowed users from Firestore.
     * This function will be called once authentication is ready and usersCollectionRef is valid.
     */
    function setupAllowedUsersListener() {
        if (!usersCollectionRef) {
            console.error("Firestore users collection reference is not initialized. Cannot set up listener.");
            return;
        }

        onSnapshot(usersCollectionRef, (snapshot) => {
            const users = [];
            snapshot.forEach(doc => {
                users.push({ id: doc.id, ...doc.data() });
            });
            ALLOWED_USERS = users;
            console.log("Allowed users updated from Firestore:", ALLOWED_USERS);

            // Re-evaluate current user's admin status and re-render if necessary
            // This handles cases where admin status changes while user is logged in
            if (auth.currentUser) { // Check if a Firebase user is active
                const currentFirebaseUserEmail = auth.currentUser.email; // Get email from Firebase Auth
                const currentFirebaseUserId = auth.currentUser.uid;

                let userFoundInAllowedList = false;
                if (currentFirebaseUserEmail) {
                    const currentUserData = ALLOWED_USERS.find(u => u.email === currentFirebaseUserEmail);
                    if (currentUserData) {
                        userFoundInAllowedList = true;
                        // Update local state based on Firestore data
                        if (isAuthenticated !== true || userEmail !== currentUserData.email || isAdminUser !== currentUserData.isAdmin) {
                            isAuthenticated = true;
                            userEmail = currentUserData.email;
                            isAdminUser = currentUserData.isAdmin;
                            currentUserId = currentFirebaseUserId;
                            console.log("User state updated from Firestore: Authenticated, Admin:", isAdminUser);
                            renderApp(); // Re-render if state changed
                        }
                    }
                } else if (auth.currentUser.isAnonymous) {
                    // Handle anonymous user: always authenticated, never admin via email list
                    if (isAuthenticated !== true || isAdminUser !== false || userEmail !== null) {
                        isAuthenticated = true;
                        userEmail = null; // No email for anonymous
                        isAdminUser = false;
                        currentUserId = currentFirebaseUserId;
                        console.log("Anonymous user state updated from Firestore.");
                        renderApp(); // Re-render if state changed
                    }
